<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Inventory Booking System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Add your CSS links or stylesheets here -->
    <style>
        body { font-family: Arial, sans-serif; background: #f7f8fa; margin: 0; }
        .container { max-width: 1100px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #0001; padding: 28px 34px; }
        .nav-active { background: #e3f2fd; color: #1565c0; }
        .nav-inactive { background: #f9f9f9; color: #888; }
        .btn-primary { background: #1976d2; }
        .btn-secondary { background: #ff9800; }
        .card-hover:hover { box-shadow: 0 2px 12px #1976d233; }
        .admin-bg { background: #f8fafc; }
    </style>
</head>
<body>
    <div class="container">
        <nav style="display: flex; gap: 12px; margin-bottom: 24px;">
            <button id="customerTab" class="nav-active px-4 py-2 rounded-lg font-semibold transition-all">Customer</button>
            <button id="adminTab" class="nav-inactive px-4 py-2 rounded-lg font-semibold transition-all">Admin</button>
        </nav>
        <div id="customerView">
            <h2 id="welcomeText"></h2>
            <!-- Booking form steps -->
            <div id="step1">
                <!-- Step 1 form fields -->
                <label>Name: <input id="customerName" required></label><br>
                <label>Phone: <input id="phone" required></label><br>
                <label>Email: <input id="email" required></label><br>
                <label>Address: <input id="address" required></label><br>
                <label>Postcode: <input id="postcode"></label><br>
                <label>Service Type:
                    <select id="serviceType">
                        <option value="">Select</option>
                        <option value="Inspection">Inspection</option>
                        <option value="Valuation">Valuation</option>
                    </select>
                </label><br>
                <label>Key Arrangement:
                    <select id="keyArrangement">
                        <option value="">Select</option>
                        <option value="Onsite">Onsite</option>
                        <option value="Agent">Agent</option>
                        <option value="Other | å…¶ä»–">Other | å…¶ä»–</option>
                    </select>
                </label>
                <div id="keyOtherSection" style="display:none;">
                    <label>Key Arrangement Details: <input id="keyOtherDetails"></label>
                </div>
                <label>Special Requirements: <input id="specialRequirements"></label><br>
                <label>Notes: <input id="notes"></label><br>
                <button id="nextStepBtn">Next</button>
            </div>
            <div id="step2" style="display:none;">
                <h3>Select Date</h3>
                <div id="dateGrid"></div>
                <div id="timeSlotSection" style="display:none;">
                    <h3>Select Time Slot</h3>
                    <div id="timeSlotGrid"></div>
                </div>
                <button id="prevStepBtn">Previous</button>
                <button id="submitBtn" disabled>Submit</button>
            </div>
            <div id="step3" style="display:none;">
                <h3>Booking Submitted!</h3>
                <p>Your order number: <span id="orderNumber"></span></p>
                <div id="bookingDetails"></div>
                <p id="afterSubmitNotice"></p>
                <button id="resetBtn">Book Again</button>
            </div>
            <div id="noticeText" style="margin-top:24px; color:#e65100;"></div>
        </div>
        <div id="adminView" style="display:none;">
            <div style="display:flex; gap:8px; margin-bottom:18px;">
                <button id="ordersTabBtn" class="flex-1 py-3 px-4 rounded-md font-medium transition-all nav-active">Orders</button>
                <button id="settingsTabBtn" class="flex-1 py-3 px-4 rounded-md font-medium transition-all nav-inactive">Settings</button>
            </div>
            <div id="ordersTab">
                <button id="showAllOrdersBtn" style="display:none; margin-bottom:10px;">Show All Orders</button>
                <div id="calendarSection" style="margin-bottom: 24px;">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <button id="prevMonth">&lt;</button>
                        <span id="currentMonthYear" style="font-weight:bold;"></span>
                        <button id="nextMonth">&gt;</button>
                    </div>
                    <div id="calendarGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-top:10px;"></div>
                </div>
                <div id="ordersList"></div>
            </div>
            <div id="settingsTab" style="display:none;">
                <label>Welcome Message:<br>
                    <textarea id="welcomeMessageInput"></textarea>
                </label><br>
                <label>Notice Message:<br>
                    <textarea id="noticeMessageInput"></textarea>
                </label><br>
                <label>After Submit Notice:<br>
                    <textarea id="afterSubmitNoticeInput"></textarea>
                </label><br>
                <button id="saveSettingsBtn">Save</button>
                <div id="statsGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:24px;"></div>
            </div>
        </div>
    </div>
    <div id="modifyModal" style="display:none; position:fixed; top:0; left:0;right:0;bottom:0; background:rgba(0,0,0,0.2); align-items:center; justify-content:center;">
        <div style="background:#fff; padding:20px; border-radius:8px; min-width:300px;">
            <h3>Modify Booking Time</h3>
            <label for="newDate">New Date:</label>
            <input type="date" id="newDate"><br><br>
            <label for="newTimeSlot">New Time Slot:</label>
            <select id="newTimeSlot">
                <option value="10:00-11:30">10:00-11:30</option>
                <option value="11:30-13:00">11:30-13:00</option>
                <option value="13:00-14:30">13:00-14:30</option>
            </select><br><br>
            <button id="confirmModify">Confirm</button>
            <button id="cancelModify">Cancel</button>
        </div>
    </div>
    <script>
        // åº”ç”¨æ•°æ®
        const appData = {
            bookings: [],
            settings: {
                welcomeMessage: 'Welcome to our property inspection booking system! We provide professional and caring property inspection services.',
                noticeMessage: 'Please note:\nâ€¢ Please ensure the appointment time is accurate\nâ€¢ For cancellations or modifications, please contact us 24 hours in advance\nâ€¢ Please prepare r[...]',
                afterSubmitNotice: 'We will confirm your appointment details within 24 hours.\nIf you have any questions, please contact us anytime.\nThank you for your trust!\n\næˆ‘ä»¬ä¼šåœ¨24å°ï¿½[...]'
            },
            nextOrderNumber: 1,
            selectedDate: '',
            selectedTimeSlot: '',
            currentCalendarDate: new Date(),
            selectedCalendarDate: null,
            showAllOrders: true,
            currentModifyingBookingId: null
        };

        // ğŸŒ äº‘ç«¯æ•°æ®å­˜å‚¨å‡½æ•°
        async function saveToCloud() {
            try {
                console.log('ğŸŒ æ­£åœ¨ä¿å­˜åˆ°äº‘ç«¯æ•°æ®åº“...');
                const response = await fetch('/api/bookings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        bookings: appData.bookings,
                        settings: appData.settings,
                        nextOrderNumber: appData.nextOrderNumber
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    console.log('âœ… äº‘ç«¯ä¿å­˜æˆåŠŸ!', result);
                    return true;
                } else {
                    console.error('âŒ äº‘ç«¯ä¿å­˜å¤±è´¥:', result);
                    return false;
                }
            } catch (error) {
                console.error('âŒ äº‘ç«¯ä¿å­˜é”™è¯¯:', error);
                return false;
            }
        }

        // ğŸ“‚ äº‘ç«¯æ•°æ®åŠ è½½å‡½æ•°
        async function loadFromCloud() {
            try {
                console.log('ğŸŒ æ­£åœ¨ä»äº‘ç«¯æ•°æ®åº“åŠ è½½...');
                const response = await fetch('/api/bookings');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('ğŸ“¦ æ”¶åˆ°äº‘ç«¯æ•°æ®:', data);
                    
                    if (data.success) {
                        // æ›´æ–°æœ¬åœ°æ•°æ®
                        appData.bookings = data.bookings || [];
                        appData.settings = { ...appData.settings, ...data.settings };
                        appData.nextOrderNumber = data.nextOrderNumber || 1;
                        
                        console.log(`âœ… æˆåŠŸåŠ è½½ ${appData.bookings.length} ä¸ªè®¢å•`);
                        return true;
                    }
                } else {
                    console.error('âŒ äº‘ç«¯åŠ è½½å¤±è´¥:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('âŒ äº‘ç«¯åŠ è½½é”™è¯¯:', error);
                return false;
            }
        }

        // ğŸ’¾ æ™ºèƒ½æ•°æ®ä¿å­˜å‡½æ•°ï¼ˆäº‘ç«¯ä¼˜å…ˆï¼Œæœ¬åœ°å¤‡ä»½ï¼‰
        async function saveData() {
            // å…ˆä¿å­˜åˆ°æœ¬åœ°ä½œä¸ºå¤‡ä»½
            try {
                const dataToSave = {
                    bookings: appData.bookings,
                    nextOrderNumber: appData.nextOrderNumber,
                    settings: appData.settings,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('propertyBookingData', JSON.stringify(dataToSave));
                console.log('ğŸ’¾ æœ¬åœ°å¤‡ä»½å·²ä¿å­˜');
            } catch (error) {
                console.error('âŒ æœ¬åœ°å¤‡ä»½å¤±è´¥:', error);
            }
            
            // å°è¯•ä¿å­˜åˆ°äº‘ç«¯
            const cloudSuccess = await saveToCloud();
            
            if (cloudSuccess) {
                console.log('ğŸ‰ æ•°æ®å·²æˆåŠŸä¿å­˜åˆ°äº‘ç«¯å¹¶æœ¬åœ°å¤‡ä»½');
            } else {
                console.log('âš ï¸ äº‘ç«¯ä¿å­˜å¤±è´¥ï¼Œä½†æœ¬åœ°å¤‡ä»½å·²ä¿å­˜');
            }
        }

        // ğŸ”„ æ™ºèƒ½æ•°æ®åŠ è½½å‡½æ•°ï¼ˆäº‘ç«¯ä¼˜å…ˆï¼Œæœ¬åœ°å…œåº•ï¼‰
        async function loadData() {
            console.log('ğŸ”„ å¼€å§‹åŠ è½½æ•°æ®...');
            
            // å°è¯•ä»äº‘ç«¯åŠ è½½
            const cloudSuccess = await loadFromCloud();
            
            if (!cloudSuccess) {
                console.log('âš ï¸ äº‘ç«¯åŠ è½½å¤±è´¥ï¼Œå°è¯•æœ¬åœ°å¤‡ä»½...');
                try {
                    const saved = localStorage.getItem('propertyBookingData');
                    if (saved) {
                        const data = JSON.parse(saved);
                        appData.bookings = data.bookings || [];
                        appData.nextOrderNumber = data.nextOrderNumber || 1;
                        if (data.settings) {
                            appData.settings = { ...appData.settings, ...data.settings };
                        }
                        console.log('ğŸ’¾ æœ¬åœ°å¤‡ä»½æ•°æ®å·²åŠ è½½');
                    }
                } catch (error) {
                    console.error('âŒ æœ¬åœ°å¤‡ä»½åŠ è½½å¤±è´¥:', error);
                }
            }
            
            console.log('âœ… æ•°æ®åŠ è½½å®Œæˆ');
        }

        // ... (All the rest of your JavaScript code from the previous index.html)
        // Please paste the remainder of your JavaScript here as in your original file.
        // For brevity, the full code is not shown here, but you should include every function and event binding.

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            setTimeout(async function() {
                try {
                    await loadData();
                    
                    bindEvents();
                    showCustomerView();
                    
                    const serviceType = document.getElementById('serviceType');
                    const keyArrangement = document.getElementById('keyArrangement');
                    
                    if (serviceType) {
                        serviceType.selectedIndex = 0;
                    }
                    if (keyArrangement) {
                        keyArrangement.selectedIndex = 0;
                    }
                    
                    console.log('ğŸ‰ åˆå§‹åŒ–å®Œæˆï¼äº‘ç«¯æ•°æ®å·²åŠ è½½');
                    
                    if (appData.bookings.length > 0) {
                        console.log(`ğŸ“Š ç³»ç»Ÿä¸­æœ‰ ${appData.bookings.length} ä¸ªè®¢å•`);
                    }
                    
                } catch (error) {
                    console.error('âŒ åˆå§‹åŒ–æ—¶å‡ºé”™:', error);
                    setTimeout(function() {
                        bindEvents();
                        showCustomerView();
                    }, 1000);
                }
            }, 300);
        });

        // (End of script)
    </script>
</body>
</html>
    <script>
        // =========================
        // FULL JAVASCRIPT CONTINUED
        // =========================

        // è§†å›¾åˆ‡æ¢
        function showCustomerView() {
            document.getElementById('customerView').style.display = 'block';
            document.getElementById('adminView').style.display = 'none';
            document.getElementById('customerTab').className = 'nav-active px-4 py-2 rounded-lg font-semibold transition-all';
            document.getElementById('adminTab').className = 'nav-inactive px-4 py-2 rounded-lg font-semibold transition-all';
        }

        function showAdminView() {
            const password = prompt('Please enter admin password | è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç :');
            if (password === 'admin123') {
                document.getElementById('customerView').style.display = 'none';
                document.getElementById('adminView').style.display = 'block';
                document.getElementById('adminTab').className = 'nav-active px-4 py-2 rounded-lg font-semibold transition-all';
                document.getElementById('customerTab').className = 'nav-inactive px-4 py-2 rounded-lg font-semibold transition-all';

                generateCalendar();
                showOrdersTab();
            } else if (password !== null) {
                alert('Incorrect password! | å¯†ç é”™è¯¯ï¼');
            }
        }

        // æ­¥éª¤æ§åˆ¶
        function showStep(stepNumber) {
            document.getElementById('step1').style.display = stepNumber === 1 ? 'block' : 'none';
            document.getElementById('step2').style.display = stepNumber === 2 ? 'block' : 'none';
            document.getElementById('step3').style.display = stepNumber === 3 ? 'block' : 'none';
        }

        // éªŒè¯ç¬¬ä¸€æ­¥
        function validateStep1() {
            const required = ['customerName', 'phone', 'email', 'address', 'serviceType', 'keyArrangement'];
            for (const field of required) {
                if (!document.getElementById(field).value.trim()) {
                    alert('Please fill in all required fields! | è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼');
                    return false;
                }
            }

            if (document.getElementById('keyArrangement').value === 'Other | å…¶ä»–') {
                if (!document.getElementById('keyOtherDetails').value.trim()) {
                    alert('Please specify the key arrangement details! | è¯·è¯¦ç»†è¯´æ˜é’¥åŒ™çš„å…·ä½“å®‰æ’ï¼');
                    return false;
                }
            }

            return true;
        }

        // ç”Ÿæˆå¯ç”¨æ—¥æœŸ
        function generateAvailableDates() {
            const dates = [];
            const today = new Date();

            for (let i = 1; i <= 30; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);

                if (date.getDay() >= 1 && date.getDay() <= 5) {
                    dates.push(date.toISOString().split('T')[0]);
                }
            }
            return dates;
        }

        // æ£€æŸ¥æ—¶é—´æ®µæ˜¯å¦è¢«é¢„çº¦
        function isTimeSlotBooked(date, timeSlot) {
            return appData.bookings.some(booking =>
                booking.preferredDate === date &&
                booking.preferredTimeSlot === timeSlot &&
                booking.status === 'confirmed'
            );
        }

        // ç”Ÿæˆæ—¥æœŸç½‘æ ¼
        function generateDateGrid() {
            const dates = generateAvailableDates();
            const dateGrid = document.getElementById('dateGrid');
            dateGrid.innerHTML = '';

            dates.slice(0, 12).forEach(date => {
                const timeSlots = ['10:00-11:30', '11:30-13:00', '13:00-14:30'];
                const hasAvailableSlots = timeSlots.some(slot => !isTimeSlotBooked(date, slot));

                if (hasAvailableSlots) {
                    const dateObj = new Date(date);
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'p-3 rounded-lg border-2 transition-all hover:scale-105 border-gray-200 hover:border-blue-300 hover:bg-blue-50 bg-white';

                    button.addEventListener('click', function () {
                        selectDate(date, this);
                    });

                    button.innerHTML = `
                        <div class="text-sm font-medium">
                            ${dateObj.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' })}
                        </div>
                        <div class="text-xs text-gray-500">
                            ${dateObj.toLocaleDateString('zh-CN', { weekday: 'short' })}
                        </div>
                    `;
                    dateGrid.appendChild(button);
                }
            });
        }

        // é€‰æ‹©æ—¥æœŸ
        function selectDate(date, button) {
            document.querySelectorAll('#dateGrid button').forEach(btn => {
                btn.className = 'p-3 rounded-lg border-2 transition-all hover:scale-105 border-gray-200 hover:border-blue-300 hover:bg-blue-50 bg-white';
            });

            button.className = 'p-3 rounded-lg border-2 transition-all hover:scale-105 border-orange-500 bg-orange-50 text-orange-700';
            appData.selectedDate = date;
            appData.selectedTimeSlot = '';

            generateTimeSlotGrid();
            document.getElementById('timeSlotSection').style.display = 'block';
            updateSubmitButton();
        }

        // ç”Ÿæˆæ—¶é—´æ®µç½‘æ ¼
        function generateTimeSlotGrid() {
            const timeSlots = ['10:00-11:30', '11:30-13:00', '13:00-14:30'];
            const timeSlotGrid = document.getElementById('timeSlotGrid');
            timeSlotGrid.innerHTML = '';

            timeSlots.forEach(timeSlot => {
                const isBooked = isTimeSlotBooked(appData.selectedDate, timeSlot);
                const button = document.createElement('button');
                button.type = 'button';

                if (isBooked) {
                    button.className = 'time-slot-booked p-4 rounded-lg font-medium transition-all';
                    button.disabled = true;
                    button.innerHTML = `
                        <div class="text-lg">${timeSlot}</div>
                        <div class="text-sm mt-1">å·²é¢„çº¦ | Booked</div>
                    `;
                } else {
                    button.className = 'time-slot-available p-4 rounded-lg font-medium transition-all';
                    button.addEventListener('click', function () {
                        selectTimeSlot(timeSlot, this);
                    });
                    button.innerHTML = `
                        <div class="text-lg">${timeSlot}</div>
                        <div class="text-sm mt-1">å¯é¢„çº¦ | Available</div>
                    `;
                }

                timeSlotGrid.appendChild(button);
            });
        }

        // é€‰æ‹©æ—¶é—´æ®µ
        function selectTimeSlot(timeSlot, button) {
            document.querySelectorAll('#timeSlotGrid button:not(:disabled)').forEach(btn => {
                btn.className = 'time-slot-available p-4 rounded-lg font-medium transition-all';
                btn.innerHTML = btn.innerHTML.replace('å·²é€‰æ‹© | Selected', 'å¯é¢„çº¦ | Available');
            });

            button.className = 'time-slot-selected p-4 rounded-lg font-medium transition-all';
            button.innerHTML = `
                <div class="text-lg">${timeSlot}</div>
                <div class="text-sm mt-1">å·²é€‰æ‹© | Selected</div>
            `;

            appData.selectedTimeSlot = timeSlot;
            updateSubmitButton();
        }

        // æ›´æ–°æäº¤æŒ‰é’®
        function updateSubmitButton() {
            const submitBtn = document.getElementById('submitBtn');
            if (appData.selectedDate && appData.selectedTimeSlot) {
                submitBtn.disabled = false;
                submitBtn.className = 'btn-primary text-white px-6 sm:px-8 py-3 rounded-lg font-semibold';
            } else {
                submitBtn.disabled = true;
                submitBtn.className = 'btn-primary text-white px-6 sm:px-8 py-3 rounded-lg font-semibold opacity-50 cursor-not-allowed';
            }
        }

        // æäº¤é¢„çº¦
        async function submitBooking() {
            const orderNum = appData.nextOrderNumber.toString().padStart(3, '0');
            const newOrderNumber = `INV-InventoryHub-${orderNum}`;
            appData.nextOrderNumber++;

            let keyArrangement = document.getElementById('keyArrangement').value;
            if (keyArrangement === 'Other | å…¶ä»–') {
                keyArrangement = 'Other | å…¶ä»–ï¼š' + document.getElementById('keyOtherDetails').value;
            }

            const newBooking = {
                id: Date.now(),
                orderNumber: newOrderNumber,
                customerName: document.getElementById('customerName').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                address: document.getElementById('address').value,
                postcode: document.getElementById('postcode').value,
                serviceType: document.getElementById('serviceType').value,
                preferredDate: appData.selectedDate,
                preferredTimeSlot: appData.selectedTimeSlot,
                keyArrangement: keyArrangement,
                specialRequirements: document.getElementById('specialRequirements').value,
                notes: document.getElementById('notes').value,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            appData.bookings.push(newBooking);
            await saveData();

            document.getElementById('orderNumber').textContent = newOrderNumber;
            document.getElementById('bookingDetails').innerHTML = `
                <p><strong>Name | å§“åï¼š</strong>${newBooking.customerName}</p>
                <p><strong>Phone | è”ç³»æ–¹å¼ï¼š</strong>${newBooking.phone}</p>
                <p><strong>Service Type | æœåŠ¡ç±»å‹ï¼š</strong>${newBooking.serviceType}</p>
                <p><strong>Date | é¢„çº¦æ—¥æœŸï¼š</strong>${newBooking.preferredDate}</p>
                <p><strong>Time | é¢„çº¦æ—¶é—´ï¼š</strong>${newBooking.preferredTimeSlot}</p>
                <p><strong>Key Arrangement | é’¥åŒ™å®‰æ’ï¼š</strong>${newBooking.keyArrangement}</p>
            `;

            showStep(3);
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            const fields = ['customerName', 'phone', 'email', 'address', 'postcode', 'specialRequirements', 'notes', 'keyOtherDetails'];
            fields.forEach(field => {
                if (document.getElementById(field)) {
                    document.getElementById(field).value = '';
                }
            });

            document.getElementById('serviceType').selectedIndex = 0;
            document.getElementById('keyArrangement').selectedIndex = 0;
            document.getElementById('keyOtherSection').style.display = 'none';

            appData.selectedDate = '';
            appData.selectedTimeSlot = '';
            document.getElementById('timeSlotSection').style.display = 'none';

            showStep(1);
        }

        // ç¡®è®¤é¢„çº¦ - ä¿®å¤ç‰ˆæœ¬
        async function confirmBooking(bookingId) {
            const booking = appData.bookings.find(b => b.id === bookingId);
            if (booking) {
                console.log('ğŸ”„ æ­£åœ¨ç¡®è®¤è®¢å•:', booking.orderNumber);
                booking.status = 'confirmed';
                await saveData();
                loadOrdersList();
                generateCalendar();
                console.log('âœ… è®¢å•ç¡®è®¤å®Œæˆï¼Œå·²åŒæ­¥åˆ°äº‘ç«¯');
                await sendConfirmationEmail(booking, false);
            }
        }

        // å–æ¶ˆé¢„çº¦ - ä¿®å¤ç‰ˆæœ¬
        async function cancelBooking(bookingId) {
            if (confirm('Are you sure you want to cancel this booking? | ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªé¢„çº¦å—ï¼Ÿ')) {
                const booking = appData.bookings.find(b => b.id === bookingId);
                if (booking) {
                    console.log('ğŸ”„ æ­£åœ¨å–æ¶ˆè®¢å•:', booking.orderNumber);
                    booking.status = 'cancelled';
                    await saveData();
                    loadOrdersList();
                    generateCalendar();
                    console.log('âœ… è®¢å•å–æ¶ˆå®Œæˆï¼Œå·²åŒæ­¥åˆ°äº‘ç«¯');
                    await sendCancellationEmail(booking);
                }
            }
        }

        // åˆ é™¤é¢„çº¦ - ä¿®å¤ç‰ˆæœ¬
        async function deleteBooking(bookingId) {
            if (confirm('Are you sure you want to delete this booking? This action cannot be undone. | ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢„çº¦å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
                const bookingIndex = appData.bookings.findIndex(b => b.id === bookingId);
                if (bookingIndex !== -1) {
                    const booking = appData.bookings[bookingIndex];
                    console.log('ğŸ”„ æ­£åœ¨åˆ é™¤è®¢å•:', booking.orderNumber);
                    appData.bookings.splice(bookingIndex, 1);
                    await saveData();
                    loadOrdersList();
                    generateCalendar();
                    console.log('âœ… è®¢å•åˆ é™¤å®Œæˆï¼Œå·²åŒæ­¥åˆ°äº‘ç«¯');
                    alert('Booking deleted successfully. | é¢„çº¦å·²æˆåŠŸåˆ é™¤ã€‚');
                }
            }
        }

        // å‘é€ç¡®è®¤é‚®ä»¶ - ä¿®å¤ç‰ˆæœ¬
        async function sendConfirmationEmail(booking, isModification = false) {
            const subject = isModification ?
                `Booking Time Modified | é¢„çº¦æ—¶é—´å·²ä¿®æ”¹ - ${booking.orderNumber}` :
                `Booking Confirmed | é¢„çº¦å·²ç¡®è®¤ - ${booking.orderNumber}`;

            console.log('ğŸš€ å¼€å§‹å‘é€é‚®ä»¶...', { to: booking.email, subject: subject });

            try {
                const response = await fetch('/api/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        to: booking.email,
                        subject: subject,
                        bookingData: {
                            type: 'confirmation',
                            booking: booking,
                            isModification: isModification
                        }
                    })
                });

                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const result = await response.json();
                    if (response.ok && result.success) {
                        alert(`âœ… ${isModification ? 'Modification notification' : 'Confirmation'} email sent successfully!`);
                    } else {
                        throw new Error(`API Error: ${result.error || 'Unknown error'}`);
                    }
                } else {
                    const text = await response.text();
                    console.error('âŒ éJSONå“åº”:', text.substring(0, 200));
                    throw new Error(`APIè¿”å›éJSONå“åº” (çŠ¶æ€: ${response.status})`);
                }
            } catch (error) {
                console.error('âŒ é‚®ä»¶å‘é€å¤±è´¥:', error);
                alert(`âŒ Failed to send email: ${error.message}\n\nThe booking is still saved successfully.`);
            }
        }

        // å‘é€å–æ¶ˆé‚®ä»¶ - ä¿®å¤ç‰ˆæœ¬
        async function sendCancellationEmail(booking) {
            try {
                const response = await fetch('/api/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        to: booking.email,
                        subject: `Booking Cancelled | é¢„çº¦å·²å–æ¶ˆ - ${booking.orderNumber}`,
                        bookingData: {
                            type: 'cancellation',
                            booking: booking,
                            isModification: false
                        }
                    })
                });

                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const result = await response.json();
                    if (response.ok && result.success) {
                        alert(`âœ… Cancellation email sent successfully!`);
                    } else {
                        throw new Error(result.error || 'Failed to send email');
                    }
                } else {
                    throw new Error(`APIè¿”å›éJSONå“åº”`);
                }
            } catch (error) {
                console.error('âŒ å–æ¶ˆé‚®ä»¶å‘é€å¤±è´¥:', error);
                alert(`âŒ Failed to send cancellation email: ${error.message}\n\nThe booking cancellation is still saved.`);
            }
        }

        // ç”Ÿæˆæ—¥å†
        function generateCalendar() {
            const year = appData.currentCalendarDate.getFullYear();
            const month = appData.currentCalendarDate.getMonth();

            document.getElementById('currentMonthYear').textContent =
                `${year}å¹´${month + 1}æœˆ | ${year}-${(month + 1).toString().padStart(2, '0')}`;

            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';

            const weekDays = ['Sun | æ—¥', 'Mon | ä¸€', 'Tue | äºŒ', 'Wed | ä¸‰', 'Thu | å››', 'Fri | äº”', 'Sat | å…­'];
            weekDays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'text-center font-semibold text-gray-600 p-2 text-xs';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });

            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);

                const dayElement = document.createElement('div');
                const dateString = currentDate.toISOString().split('T')[0];

                dayElement.className = 'relative p-2 text-center border border-gray-100 rounded min-h-[60px] flex flex-col justify-center cursor-pointer transition-all hover:bg-gray-50';
                dayElement.setAttribute('data-date', dateString);

                const isCurrentMonth = currentDate.getMonth() === month;
                const hasBookings = appData.bookings.some(booking =>
                    booking.preferredDate === dateString && booking.status === 'confirmed'
                );

                const isSelected = appData.selectedCalendarDate === dateString;

                if (isCurrentMonth) {
                    if (isSelected) {
                        dayElement.className += ' calendar-day-selected bg-orange-200 border-orange-400 text-gray-900';
                    } else {
                        dayElement.className += ' bg-white text-gray-900';
                        if (hasBookings) {
                            dayElement.className += ' bg-blue-100 border-blue-300';
                        }
                    }
                    dayElement.addEventListener('click', () => handleCalendarDayClick(dateString));
                } else {
                    dayElement.className += ' bg-gray-50 text-gray-400 cursor-default';
                }

                dayElement.innerHTML = `
                    <div class="text-sm font-medium">${currentDate.getDate()}</div>
                    ${hasBookings ? '<div class="w-2 h-2 bg-blue-500 rounded-full mx-auto mt-1"></div>' : ''}
                `;

                calendarGrid.appendChild(dayElement);
            }
        }

        // æ—¥å†ç‚¹å‡»å¤„ç†
        function handleCalendarDayClick(dateString) {
            const showAllBtn = document.getElementById('showAllOrdersBtn');

            if (appData.selectedCalendarDate === dateString) {
                appData.selectedCalendarDate = null;
                appData.showAllOrders = true;
                showAllBtn.style.display = 'none';
                generateCalendar();
            } else {
                appData.selectedCalendarDate = dateString;
                appData.showAllOrders = false;
                showAllBtn.style.display = 'block';
                generateCalendar();
            }

            loadOrdersList();
        }

        // ç®¡ç†å‘˜æ ‡ç­¾é¡µåˆ‡æ¢
        function showOrdersTab() {
            document.getElementById('ordersTab').style.display = 'block';
            document.getElementById('settingsTab').style.display = 'none';
            document.getElementById('ordersTabBtn').className = 'flex-1 py-3 px-4 rounded-md font-medium transition-all nav-active';
            document.getElementById('settingsTabBtn').className = 'flex-1 py-3 px-4 rounded-md font-medium transition-all nav-inactive';
            loadOrdersList();
        }

        function showSettingsTab() {
            document.getElementById('ordersTab').style.display = 'none';
            document.getElementById('settingsTab').style.display = 'block';
            document.getElementById('ordersTabBtn').className = 'flex-1 py-3 px-4 rounded-md font-medium transition-all nav-inactive';
            document.getElementById('settingsTabBtn').className = 'flex-1 py-3 px-4 rounded-md font-medium transition-all nav-active';

            document.getElementById('welcomeMessageInput').value = appData.settings.welcomeMessage;
            document.getElementById('noticeMessageInput').value = appData.settings.noticeMessage;
            document.getElementById('afterSubmitNoticeInput').value = appData.settings.afterSubmitNotice;
            updateStats();
        }

        // åŠ è½½è®¢å•åˆ—è¡¨
        function loadOrdersList() {
            const ordersList = document.getElementById('ordersList');

            let filteredBookings = appData.bookings;
            if (!appData.showAllOrders && appData.selectedCalendarDate) {
                filteredBookings = appData.bookings.filter(booking =>
                    booking.preferredDate === appData.selectedCalendarDate
                );
            }

            if (filteredBookings.length === 0) {
                const message = appData.showAllOrders ?
                    'No orders found | æš‚æ— è®¢å•' :
                    'No orders for selected date | æ‰€é€‰æ—¥æœŸæ— è®¢å•';
                ordersList.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-4xl mb-4">ğŸ“‹</div>
                        <p class="text-gray-500">${message}</p>
                    </div>
                `;
                return;
            }

            ordersList.innerHTML = filteredBookings.slice().reverse().map(booking => `
                <div class="admin-bg rounded-lg p-4 mb-4 card-hover border border-gray-200">
                    <div class="flex flex-col sm:flex-row justify-between items-start mb-3">
                        <div>
                            <h4 class="font-bold text-lg text-blue-900">${booking.orderNumber}</h4>
                            <p class="text-gray-600">${booking.customerName} â€¢ ${booking.phone}</p>
                        </div>
                        <span class="mt-2 sm:mt-0 px-3 py-1 rounded-full text-xs font-medium ${getStatusBadgeClass(booking.status)}">
                            ${getStatusLabel(booking.status)}
                        </span>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-gray-700"><strong>Service Type | æœåŠ¡ç±»å‹ï¼š</strong>${booking.serviceType}</p>
                            <p class="text-gray-700"><strong>Date & Time | é¢„çº¦æ—¶é—´ï¼š</strong>${booking.preferredDate} ${booking.preferredTimeSlot}</p>
                            <p class="text-gray-700"><strong>Key Arrangement | é’¥åŒ™å®‰æ’ï¼š</strong>${booking.keyArrangement}</p>
                        </div>
                        <div>
                            <p class="text-gray-700"><strong>Address | åœ°å€ï¼š</strong>${booking.address}</p>
                            <p class="text-gray-700"><strong>Email | é‚®ç®±ï¼š</strong>${booking.email}</p>
                        </div>
                    </div>

                    ${booking.notes ? `
                        <div class="mb-4">
                            <p class="text-gray-700"><strong>Notes | å¤‡æ³¨ï¼š</strong></p>
                            <p class="text-gray-600 bg-gray-100 p-2 rounded">${booking.notes}</p>
                        </div>
                    ` : ''}

                    <div class="flex flex-col sm:flex-row gap-2">
                        ${booking.status === 'pending' ? `
                            <button data-booking-id="${booking.id}" class="confirm-btn btn-primary text-white px-4 py-2 rounded-lg text-sm">
                                Confirm | ç¡®è®¤é¢„çº¦
                            </button>
                        ` : ''}

                        ${booking.status === 'confirmed' ? `
                            <button data-booking-id="${booking.id}" class="modify-btn btn-secondary text-white px-4 py-2 rounded-lg text-sm">
                                Modify Time | ä¿®æ”¹æ—¶é—´
                            </button>
                        ` : ''}

                        <button data-booking-id="${booking.id}" class="cancel-btn bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600 transition-all">
                            Cancel | å–æ¶ˆ
                        </button>

                        <button data-booking-id="${booking.id}" class="delete-btn bg-gray-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-600 transition-all">
                            Delete | åˆ é™¤
                        </button>
                    </div>
                </div>
            `).join('');

            bindOrderButtons();
        }

        // ç»‘å®šè®¢å•æŒ‰é’®äº‹ä»¶
        function bindOrderButtons() {
            document.querySelectorAll('.confirm-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const bookingId = parseInt(this.dataset.bookingId);
                    confirmBooking(bookingId);
                });
            });

            document.querySelectorAll('.cancel-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const bookingId = parseInt(this.dataset.bookingId);
                    cancelBooking(bookingId);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const bookingId = parseInt(this.dataset.bookingId);
                    deleteBooking(bookingId);
                });
            });

            document.querySelectorAll('.modify-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const bookingId = parseInt(this.dataset.bookingId);
                    showModifyModal(bookingId);
                });
            });
        }

        // æ˜¾ç¤ºä¿®æ”¹æ—¶é—´å¼¹çª—
        function showModifyModal(bookingId) {
            const booking = appData.bookings.find(b => b.id === bookingId);
            if (!booking) return;

            appData.currentModifyingBookingId = bookingId;

            document.getElementById('newDate').value = booking.preferredDate;
            document.getElementById('newTimeSlot').value = booking.preferredTimeSlot;

            document.getElementById('modifyModal').style.display = 'flex';
        }

        // éšè—ä¿®æ”¹å¼¹çª—
        function hideModifyModal() {
            document.getElementById('modifyModal').style.display = 'none';
            appData.currentModifyingBookingId = null;
        }

        // ç¡®è®¤ä¿®æ”¹æ—¶é—´ - ä¿®å¤ç‰ˆæœ¬
        async function confirmModifyTime() {
            const newDate = document.getElementById('newDate').value;
            const newTimeSlot = document.getElementById('newTimeSlot').value;

            if (!newDate || !newTimeSlot) {
                alert('Please fill in all fields | è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                return;
            }

            const booking = appData.bookings.find(b => b.id === appData.currentModifyingBookingId);
            if (!booking) return;

            const isConflict = appData.bookings.some(b =>
                b.id !== appData.currentModifyingBookingId &&
                b.preferredDate === newDate &&
                b.preferredTimeSlot === newTimeSlot &&
                b.status === 'confirmed'
            );

            if (isConflict) {
                alert('Time slot conflict! Please choose another time. | æ—¶é—´å†²çªï¼è¯·é€‰æ‹©å…¶ä»–æ—¶é—´ã€‚');
                return;
            }

            console.log('ğŸ”„ æ­£åœ¨ä¿®æ”¹è®¢å•æ—¶é—´:', booking.orderNumber);

            booking.preferredDate = newDate;
            booking.preferredTimeSlot = newTimeSlot;

            await saveData();

            hideModifyModal();
            loadOrdersList();
            generateCalendar();

            console.log('âœ… æ—¶é—´ä¿®æ”¹å®Œæˆï¼Œå·²åŒæ­¥åˆ°äº‘ç«¯');

            await sendConfirmationEmail(booking, true);
        }

        // è·å–çŠ¶æ€æ ·å¼ç±»
        function getStatusBadgeClass(status) {
            const classes = {
                pending: 'bg-yellow-100 text-yellow-800',
                confirmed: 'bg-green-100 text-green-800',
                completed: 'bg-blue-100 text-blue-800',
                cancelled: 'bg-gray-100 text-gray-800'
            };
            return classes[status] || classes.pending;
        }

        // è·å–çŠ¶æ€æ ‡ç­¾
        function getStatusLabel(status) {
            const labels = {
                pending: 'Pending | å¾…ç¡®è®¤',
                confirmed: 'Confirmed | å·²ç¡®è®¤',
                completed: 'Completed | å·²å®Œæˆ',
                cancelled: 'Cancelled | å·²å–æ¶ˆ'
            };
            return labels[status] || 'Pending | å¾…ç¡®è®¤';
        }

        // æ›´æ–°è®¾ç½®
        async function updateSettings() {
            appData.settings.welcomeMessage = document.getElementById('welcomeMessageInput').value;
            appData.settings.noticeMessage = document.getElementById('noticeMessageInput').value;
            appData.settings.afterSubmitNotice = document.getElementById('afterSubmitNoticeInput').value;

            await saveData();

            const welcomeParagraphs = document.querySelectorAll('#welcomeText');
            if (welcomeParagraphs.length > 0) {
                welcomeParagraphs[0].textContent = appData.settings.welcomeMessage;
            }
            document.getElementById('noticeText').textContent = appData.settings.noticeMessage;
            document.getElementById('afterSubmitNotice').textContent = appData.settings.afterSubmitNotice;

            alert('Settings saved successfully! | è®¾ç½®å·²ä¿å­˜ï¼');
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            const statsGrid = document.getElementById('statsGrid');
            const totalBookings = appData.bookings.length;
            const pendingBookings = appData.bookings.filter(b => b.status === 'pending').length;
            const confirmedBookings = appData.bookings.filter(b => b.status === 'confirmed').length;
            const completedBookings = appData.bookings.filter(b => b.status === 'completed').length;

            statsGrid.innerHTML = `
                <div class="bg-white p-3 rounded-lg border border-gray-200">
                    <div class="text-2xl font-bold text-blue-900">${totalBookings}</div>
                    <div class="text-sm text-blue-700">Total | æ€»è®¢å•</div>
                </div>
                <div class="bg-white p-3 rounded-lg border border-gray-200">
                    <div class="text-2xl font-bold text-yellow-600">${pendingBookings}</div>
                    <div class="text-sm text-yellow-700">Pending | å¾…ç¡®è®¤</div>
                </div>
                <div class="bg-white p-3 rounded-lg border border-gray-200">
                    <div class="text-2xl font-bold text-green-600">${confirmedBookings}</div>
                    <div class="text-sm text-green-700">Confirmed | å·²ç¡®è®¤</div>
                </div>
                <div class="bg-white p-3 rounded-lg border border-gray-200">
                    <div class="text-2xl font-bold text-blue-600">${completedBookings}</div>
                    <div class="text-sm text-blue-700">Completed | å·²å®Œæˆ</div>
                </div>
            `;
        }

        // äº‹ä»¶ç»‘å®š
        function bindEvents() {
            const customerTab = document.getElementById('customerTab');
            const adminTab = document.getElementById('adminTab');
            const nextStepBtn = document.getElementById('nextStepBtn');
            const prevStepBtn = document.getElementById('prevStepBtn');
            const submitBtn = document.getElementById('submitBtn');
            const resetBtn = document.getElementById('resetBtn');
            const keyArrangement = document.getElementById('keyArrangement');
            const prevMonth = document.getElementById('prevMonth');
            const nextMonth = document.getElementById('nextMonth');
            const ordersTabBtn = document.getElementById('ordersTabBtn');
            const settingsTabBtn = document.getElementById('settingsTabBtn');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const showAllOrdersBtn = document.getElementById('showAllOrdersBtn');
            const cancelModify = document.getElementById('cancelModify');
            const confirmModify = document.getElementById('confirmModify');
            const modifyModal = document.getElementById('modifyModal');

            if (customerTab) {
                customerTab.addEventListener('click', showCustomerView);
            }
            if (adminTab) {
                adminTab.addEventListener('click', showAdminView);
            }

            if (nextStepBtn) {
                nextStepBtn.addEventListener('click', function () {
                    if (validateStep1()) {
                        showStep(2);
                        generateDateGrid();
                    }
                });
            }

            if (prevStepBtn) {
                prevStepBtn.addEventListener('click', function () {
                    showStep(1);
                });
            }

            if (submitBtn) {
                submitBtn.addEventListener('click', submitBooking);
            }

            if (resetBtn) {
                resetBtn.addEventListener('click', resetForm);
            }

            if (keyArrangement) {
                keyArrangement.addEventListener('change', function () {
                    const keyOtherSection = document.getElementById('keyOtherSection');
                    if (this.value === 'Other | å…¶ä»–') {
                        keyOtherSection.style.display = 'block';
                    } else {
                        keyOtherSection.style.display = 'none';
                        const keyOtherDetails = document.getElementById('keyOtherDetails');
                        if (keyOtherDetails) {
                            keyOtherDetails.value = '';
                        }
                    }
                });
            }

            if (prevMonth) {
                prevMonth.addEventListener('click', function () {
                    appData.currentCalendarDate.setMonth(appData.currentCalendarDate.getMonth() - 1);
                    generateCalendar();
                });
            }

            if (nextMonth) {
                nextMonth.addEventListener('click', function () {
                    appData.currentCalendarDate.setMonth(appData.currentCalendarDate.getMonth() + 1);
                    generateCalendar();
                });
            }

            if (ordersTabBtn) {
                ordersTabBtn.addEventListener('click', showOrdersTab);
            }

            if (settingsTabBtn) {
                settingsTabBtn.addEventListener('click', showSettingsTab);
            }

            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', updateSettings);
            }

            if (showAllOrdersBtn) {
                showAllOrdersBtn.addEventListener('click', function () {
                    appData.selectedCalendarDate = null;
                    appData.showAllOrders = true;
                    this.style.display = 'none';
                    generateCalendar();
                    loadOrdersList();
                });
            }

            if (cancelModify) {
                cancelModify.addEventListener('click', hideModifyModal);
            }

            if (confirmModify) {
                confirmModify.addEventListener('click', confirmModifyTime);
            }

            if (modifyModal) {
                modifyModal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        hideModifyModal();
                    }
                });
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');

            setTimeout(async function () {
                try {
                    await loadData();

                    bindEvents();
                    showCustomerView();

                    const serviceType = document.getElementById('serviceType');
                    const keyArrangement = document.getElementById('keyArrangement');

                    if (serviceType) {
                        serviceType.selectedIndex = 0;
                    }
                    if (keyArrangement) {
                        keyArrangement.selectedIndex = 0;
                    }

                    console.log('ğŸ‰ åˆå§‹åŒ–å®Œæˆï¼äº‘ç«¯æ•°æ®å·²åŠ è½½');

                    if (appData.bookings.length > 0) {
                        console.log(`ğŸ“Š ç³»ç»Ÿä¸­æœ‰ ${appData.bookings.length} ä¸ªè®¢å•`);
                    }

                } catch (error) {
                    console.error('âŒ åˆå§‹åŒ–æ—¶å‡ºé”™:', error);
                    setTimeout(function () {
                        bindEvents();
                        showCustomerView();
                    }, 1000);
                }
            }, 300);
        });
    </script>
