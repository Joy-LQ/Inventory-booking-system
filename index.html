<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Inventory Booking System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Add your CSS links or stylesheets here -->
    <style>
        body { font-family: Arial, sans-serif; background: #f7f8fa; margin: 0; }
        .container { max-width: 1100px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #0001; padding: 28px 34px; }
        .nav-active { background: #e3f2fd; color: #1565c0; }
        .nav-inactive { background: #f9f9f9; color: #888; }
        .btn-primary { background: #1976d2; }
        .btn-secondary { background: #ff9800; }
        .card-hover:hover { box-shadow: 0 2px 12px #1976d233; }
        .admin-bg { background: #f8fafc; }
    </style>
</head>
<body>
    <div class="container">
        <nav style="display: flex; gap: 12px; margin-bottom: 24px;">
            <button id="customerTab" class="nav-active px-4 py-2 rounded-lg font-semibold transition-all">Customer</button>
            <button id="adminTab" class="nav-inactive px-4 py-2 rounded-lg font-semibold transition-all">Admin</button>
        </nav>
        <div id="customerView">
            <h2 id="welcomeText"></h2>
            <!-- Booking form steps -->
            <div id="step1">
                <!-- Step 1 form fields -->
                <label>Name: <input id="customerName" required></label><br>
                <label>Phone: <input id="phone" required></label><br>
                <label>Email: <input id="email" required></label><br>
                <label>Address: <input id="address" required></label><br>
                <label>Postcode: <input id="postcode"></label><br>
                <label>Service Type:
                    <select id="serviceType">
                        <option value="">Select</option>
                        <option value="Inspection">Inspection</option>
                        <option value="Valuation">Valuation</option>
                    </select>
                </label><br>
                <label>Key Arrangement:
                    <select id="keyArrangement">
                        <option value="">Select</option>
                        <option value="Onsite">Onsite</option>
                        <option value="Agent">Agent</option>
                        <option value="Other | 其他">Other | 其他</option>
                    </select>
                </label>
                <div id="keyOtherSection" style="display:none;">
                    <label>Key Arrangement Details: <input id="keyOtherDetails"></label>
                </div>
                <label>Special Requirements: <input id="specialRequirements"></label><br>
                <label>Notes: <input id="notes"></label><br>
                <button id="nextStepBtn">Next</button>
            </div>
            <div id="step2" style="display:none;">
                <h3>Select Date</h3>
                <div id="dateGrid"></div>
                <div id="timeSlotSection" style="display:none;">
                    <h3>Select Time Slot</h3>
                    <div id="timeSlotGrid"></div>
                </div>
                <button id="prevStepBtn">Previous</button>
                <button id="submitBtn" disabled>Submit</button>
            </div>
            <div id="step3" style="display:none;">
                <h3>Booking Submitted!</h3>
                <p>Your order number: <span id="orderNumber"></span></p>
                <div id="bookingDetails"></div>
                <p id="afterSubmitNotice"></p>
                <button id="resetBtn">Book Again</button>
            </div>
            <div id="noticeText" style="margin-top:24px; color:#e65100;"></div>
        </div>
        <div id="adminView" style="display:none;">
            <div style="display:flex; gap:8px; margin-bottom:18px;">
                <button id="ordersTabBtn" class="flex-1 py-3 px-4 rounded-md font-medium transition-all nav-active">Orders</button>
                <button id="settingsTabBtn" class="flex-1 py-3 px-4 rounded-md font-medium transition-all nav-inactive">Settings</button>
            </div>
            <div id="ordersTab">
                <button id="showAllOrdersBtn" style="display:none; margin-bottom:10px;">Show All Orders</button>
                <div id="calendarSection" style="margin-bottom: 24px;">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <button id="prevMonth">&lt;</button>
                        <span id="currentMonthYear" style="font-weight:bold;"></span>
                        <button id="nextMonth">&gt;</button>
                    </div>
                    <div id="calendarGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-top:10px;"></div>
                </div>
                <div id="ordersList"></div>
            </div>
            <div id="settingsTab" style="display:none;">
                <label>Welcome Message:<br>
                    <textarea id="welcomeMessageInput"></textarea>
                </label><br>
                <label>Notice Message:<br>
                    <textarea id="noticeMessageInput"></textarea>
                </label><br>
                <label>After Submit Notice:<br>
                    <textarea id="afterSubmitNoticeInput"></textarea>
                </label><br>
                <button id="saveSettingsBtn">Save</button>
                <div id="statsGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:24px;"></div>
            </div>
        </div>
    </div>
    <div id="modifyModal" style="display:none; position:fixed; top:0; left:0;right:0;bottom:0; background:rgba(0,0,0,0.2); align-items:center; justify-content:center;">
        <div style="background:#fff; padding:20px; border-radius:8px; min-width:300px;">
            <h3>Modify Booking Time</h3>
            <label for="newDate">New Date:</label>
            <input type="date" id="newDate"><br><br>
            <label for="newTimeSlot">New Time Slot:</label>
            <select id="newTimeSlot">
                <option value="10:00-11:30">10:00-11:30</option>
                <option value="11:30-13:00">11:30-13:00</option>
                <option value="13:00-14:30">13:00-14:30</option>
            </select><br><br>
            <button id="confirmModify">Confirm</button>
            <button id="cancelModify">Cancel</button>
        </div>
    </div>
    <script>
        // 应用数据
        const appData = {
            bookings: [],
            settings: {
                welcomeMessage: 'Welcome to our property inspection booking system! We provide professional and caring property inspection services.',
                noticeMessage: 'Please note:\n• Please ensure the appointment time is accurate\n• For cancellations or modifications, please contact us 24 hours in advance\n• Please prepare r[...]',
                afterSubmitNotice: 'We will confirm your appointment details within 24 hours.\nIf you have any questions, please contact us anytime.\nThank you for your trust!\n\n我们会在24小�[...]'
            },
            nextOrderNumber: 1,
            selectedDate: '',
            selectedTimeSlot: '',
            currentCalendarDate: new Date(),
            selectedCalendarDate: null,
            showAllOrders: true,
            currentModifyingBookingId: null
        };

        // 🌐 云端数据存储函数
        async function saveToCloud() {
            try {
                console.log('🌐 正在保存到云端数据库...');
                const response = await fetch('/api/bookings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        bookings: appData.bookings,
                        settings: appData.settings,
                        nextOrderNumber: appData.nextOrderNumber
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    console.log('✅ 云端保存成功!', result);
                    return true;
                } else {
                    console.error('❌ 云端保存失败:', result);
                    return false;
                }
            } catch (error) {
                console.error('❌ 云端保存错误:', error);
                return false;
            }
        }

        // 📂 云端数据加载函数
        async function loadFromCloud() {
            try {
                console.log('🌐 正在从云端数据库加载...');
                const response = await fetch('/api/bookings');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('📦 收到云端数据:', data);
                    
                    if (data.success) {
                        // 更新本地数据
                        appData.bookings = data.bookings || [];
                        appData.settings = { ...appData.settings, ...data.settings };
                        appData.nextOrderNumber = data.nextOrderNumber || 1;
                        
                        console.log(`✅ 成功加载 ${appData.bookings.length} 个订单`);
                        return true;
                    }
                } else {
                    console.error('❌ 云端加载失败:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('❌ 云端加载错误:', error);
                return false;
            }
        }

        // 💾 智能数据保存函数（云端优先，本地备份）
        async function saveData() {
            // 先保存到本地作为备份
            try {
                const dataToSave = {
                    bookings: appData.bookings,
                    nextOrderNumber: appData.nextOrderNumber,
                    settings: appData.settings,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('propertyBookingData', JSON.stringify(dataToSave));
                console.log('💾 本地备份已保存');
            } catch (error) {
                console.error('❌ 本地备份失败:', error);
            }
            
            // 尝试保存到云端
            const cloudSuccess = await saveToCloud();
            
            if (cloudSuccess) {
                console.log('🎉 数据已成功保存到云端并本地备份');
            } else {
                console.log('⚠️ 云端保存失败，但本地备份已保存');
            }
        }

        // 🔄 智能数据加载函数（云端优先，本地兜底）
        async function loadData() {
            console.log('🔄 开始加载数据...');
            
            // 尝试从云端加载
            const cloudSuccess = await loadFromCloud();
            
            if (!cloudSuccess) {
                console.log('⚠️ 云端加载失败，尝试本地备份...');
                try {
                    const saved = localStorage.getItem('propertyBookingData');
                    if (saved) {
                        const data = JSON.parse(saved);
                        appData.bookings = data.bookings || [];
                        appData.nextOrderNumber = data.nextOrderNumber || 1;
                        if (data.settings) {
                            appData.settings = { ...appData.settings, ...data.settings };
                        }
                        console.log('💾 本地备份数据已加载');
                    }
                } catch (error) {
                    console.error('❌ 本地备份加载失败:', error);
                }
            }
            
            console.log('✅ 数据加载完成');
        }

        // ... (All the rest of your JavaScript code from the previous index.html)
        // Please paste the remainder of your JavaScript here as in your original file.
        // For brevity, the full code is not shown here, but you should include every function and event binding.

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 页面加载完成，开始初始化...');
            
            setTimeout(async function() {
                try {
                    await loadData();
                    
                    bindEvents();
                    showCustomerView();
                    
                    const serviceType = document.getElementById('serviceType');
                    const keyArrangement = document.getElementById('keyArrangement');
                    
                    if (serviceType) {
                        serviceType.selectedIndex = 0;
                    }
                    if (keyArrangement) {
                        keyArrangement.selectedIndex = 0;
                    }
                    
                    console.log('🎉 初始化完成！云端数据已加载');
                    
                    if (appData.bookings.length > 0) {
                        console.log(`📊 系统中有 ${appData.bookings.length} 个订单`);
                    }
                    
                } catch (error) {
                    console.error('❌ 初始化时出错:', error);
                    setTimeout(function() {
                        bindEvents();
                        showCustomerView();
                    }, 1000);
                }
            }, 300);
        });

        // (End of script)
    </script>
</body>
</html>
